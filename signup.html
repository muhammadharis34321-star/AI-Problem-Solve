@app.route('/api/google-signup', methods=['POST'])
def google_signup():
    try:
        data = request.get_json()
        credential = data.get('credential')
        
        # Verify Google token
        idinfo = id_token.verify_oauth2_token(
            credential, 
            requests.Request(), 
            'YOUR_GOOGLE_CLIENT_ID'
        )
        
        email = idinfo['email']
        name = idinfo.get('name', '')
        google_id = idinfo['sub']
        
        # Check if Google account already exists
        existing_user = User.query.filter_by(google_id=google_id).first()
        if existing_user:
            return jsonify({
                'success': False,
                'error': 'GOOGLE_ACCOUNT_EXISTS'
            }), 409
        
        # Check if email already exists with different provider
        existing_email = User.query.filter_by(email=email).first()
        if existing_email:
            return jsonify({
                'success': False,
                'error': 'EMAIL_ALREADY_EXISTS'
            }), 409
        
        # Create new user with Google account
        new_user = User(
            email=email,
            name=name,
            google_id=google_id,
            is_verified=True
        )
        db.session.add(new_user)
        db.session.commit()
        
        token = generate_token(new_user)
        return jsonify({
            'success': True,
            'user': new_user.to_dict(),
            'token': token
        })
            
    except ValueError as e:
        return jsonify({'success': False, 'error': 'Invalid Google token'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

@app.route('/api/facebook-signup', methods=['POST'])
def facebook_signup():
    try:
        data = request.get_json()
        access_token = data.get('access_token')
        
        # Verify Facebook token
        graph = facebook.GraphAPI(access_token=access_token)
        profile = graph.get_object("me", fields='id,name,email')
        
        facebook_id = profile['id']
        email = profile.get('email')
        name = profile.get('name', '')
        
        if not email:
            return jsonify({'success': False, 'error': 'Email not provided by Facebook'})
        
        # Check if Facebook account already exists
        existing_user = User.query.filter_by(facebook_id=facebook_id).first()
        if existing_user:
            return jsonify({
                'success': False,
                'error': 'FACEBOOK_ACCOUNT_EXISTS'
            }), 409
        
        # Check if email already exists with different provider
        existing_email = User.query.filter_by(email=email).first()
        if existing_email:
            return jsonify({
                'success': False,
                'error': 'EMAIL_ALREADY_EXISTS'
            }), 409
        
        # Create new user with Facebook account
        new_user = User(
            email=email,
            name=name,
            facebook_id=facebook_id,
            is_verified=True
        )
        db.session.add(new_user)
        db.session.commit()
        
        token = generate_token(new_user)
        return jsonify({
            'success': True,
            'user': new_user.to_dict(),
            'token': token
        })
            
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})
