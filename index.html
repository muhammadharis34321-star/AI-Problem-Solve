<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="google-site-verification" content="KjhbTLya1ngONTyWGFpuTM82qfQmg9GDb1vLmWsyufo" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI PROBLEM SOLVE</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712035.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      /* Guest Message Counter Styles */
      .guest-counter {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      }

      .counter-info {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-bottom: 10px;
        font-size: 16px;
        font-weight: 600;
      }

      .counter-info i {
        font-size: 20px;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255,255,255,0.3);
        border-radius: 4px;
        overflow: hidden;
        margin: 12px 0;
      }

      .progress-fill {
        height: 100%;
        background: #4CAF50;
        transition: width 0.3s ease;
        border-radius: 4px;
      }

      .login-prompt {
        margin-top: 12px;
        font-size: 14px;
      }

      .login-link {
        color: #FFEB3B;
        text-decoration: none;
        font-weight: bold;
        padding: 8px 16px;
        border: 2px solid #FFEB3B;
        border-radius: 20px;
        transition: all 0.3s ease;
      }

      .login-link:hover {
        background: #FFEB3B;
        color: #333;
        text-decoration: none;
      }

      /* Limit Exceeded Styles */
      .limit-exceeded {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        margin: 30px 0;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      }

      .limit-exceeded h4 {
        margin: 0 0 15px 0;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .limit-exceeded p {
        margin: 0 0 20px 0;
        font-size: 16px;
        line-height: 1.5;
      }

      /* Input container when limit exceeded */
      .input-disabled {
        opacity: 0.5;
        pointer-events: none;
      }

      .limit-warning {
        background: #fff3cd;
        color: #856404;
        padding: 12px 15px;
        border-radius: 8px;
        margin: 10px 0;
        border-left: 4px solid #ffc107;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="user-profile">
            <img
              src="https://static.vecteezy.com/system/resources/previews/048/926/084/non_2x/silver-membership-icon-default-avatar-profile-icon-membership-icon-social-media-user-image-illustration-vector.jpg"
              alt="Profile Picture"
              class="profile-picture"
              id="profilePicture"
            />
            <div class="profile-controls">
              <button class="profile-btn" id="changeDpBtn">Change</button>
              <button class="profile-btn" id="removeDpBtn">Remove</button>
            </div>
          </div>
        </div>

        <div class="conversation-controls">
          <button id="newChat" class="sidebar-btn">
            <i class="fas fa-plus"></i> New Chat
          </button>
          <button id="clearHistory" class="sidebar-btn" onclick="clearChatHistory()">
            <i class="fas fa-trash"></i> Clear History
          </button>
          <button id="settingsBtn" class="sidebar-btn">
            <i class="fas fa-cog"></i> Settings
          </button>
        </div>

        <div class="theme-toggle">
          <span>Dark Mode</span>
          <label class="toggle-switch">
            <input type="checkbox" id="darkModeToggle" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="language-selector">
          <label for="language">Language:</label>
          <select id="language">
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="zh">Chinese</option>
            <option value="ja">Japanese</option>
            <option value="ar">Arabic</option>
            <option value="hi">Hindi</option>
            <option value="ru">Russian</option>
          </select>
        </div>
      </div>

      <!-- Main Chat Area -->
      <div class="main-content">
        <div class="chat-header">
          <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
          </button>

          <div class="chat-title">
            <div id="normalText">AI PROBLEM SOLVE</div>
          </div>
          <div class="chat-controls1">
            <button class="control-btn1" id="aiToggle">ON</button>
            <button class="control-btn" id="textColorBtn"></button>
          </div>
        </div>

        <div class="chat-container" id="chatContainer">
          <div class="welcome-message" id="welcomeMessage">
            <h1 id="heading">AI PROBLEM SOLVE</h1>
            <p>
              How can I help you today? I can assist with problem solving and much more!
            </p>
            <!-- Guest Message Counter -->
            <div class="guest-counter" id="guestCounter" style="display: none;">
              <div class="counter-info">
                <i class="fas fa-info-circle"></i>
                <span>Guest User: <span id="remainingMessages">3</span> messages remaining</span>
              </div>
              <div class="counter-progress">
                <div class="progress-bar">
                  <div class="progress-fill" id="progressFill" style="width: 100%"></div>
                </div>
              </div>
              <div class="login-prompt">
                <a href="login.html" class="login-link">
                  <i class="fas fa-sign-in-alt"></i> Login for unlimited messages
                </a>
              </div>
            </div>
          </div>
          <div class="messages-container" id="messagesContainer"></div>
          
          <!-- Limit Exceeded Message -->
          <div class="limit-exceeded" id="limitExceeded" style="display: none;">
            <h4>
              <i class="fas fa-exclamation-triangle"></i> Message Limit Reached
            </h4>
            <p>You've used all 3 free messages. Please login to continue chatting with AI.</p>
            <a href="login.html" class="login-link">
              <i class="fas fa-sign-in-alt"></i> Login Now
            </a>
          </div>
        </div>

        <div class="input-container" id="inputContainer">
          <!-- Limit Warning -->
          <div class="limit-warning" id="limitWarning" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <span>You have <span id="warningCount">1</span> message(s) left. Login for unlimited access.</span>
          </div>
          
          <div class="image-upload">
            <input
              type="file"
              id="imageInput"
              accept="image/*"
              style="display: none"
            />
            <button id="uploadBtn" class="upload-btn">
              <i class="fas fa-image"></i>
            </button>
            <span id="fileName" class="file-name"></span>
          </div>

          <div class="text-input-container">
            <textarea
              id="userInput"
              placeholder="Type your message here..."
              rows="1"
            ></textarea>

            <button id="sendButton" class="send-btn" onclick="sendMessage()">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Settings</h3>
          <button class="close-modal" id="closeSettings">&times;</button>
        </div>
        <div class="modal-body">
          <div class="tab-container">
            <div class="tab-buttons">
              <button class="tab-button active" data-tab="appearance">
                Appearance
              </button>
              <button class="tab-button" data-tab="history">History</button>
              <button class="tab-button" data-tab="logout">Logout</button>
            </div>
            <div class="tab-content">
              <div class="tab-pane active" id="appearanceTab">
                <div class="setting-group">
                  <h4>Text Color</h4>
                  <div class="color-picker" id="textColorPicker">
                    <div
                      class="color-option active"
                      style="background-color: #333"
                      data-color="#333"
                    ></div>
                    <div
                      class="color-option"
                      style="background-color: #6a11cb"
                      data-color="#6a11cb"
                    ></div>
                    <div
                      class="color-option"
                      style="background-color: #2575fc"
                      data-color="#2575fc"
                    ></div>
                    <div
                      class="color-option"
                      style="background-color: #00c6ff"
                      data-color="#00c6ff"
                    ></div>
                    <div
                      class="color-option"
                      style="background-color: #e74c3c"
                      data-color="#e74c3c"
                    ></div>
                    <div
                      class="color-option"
                      style="background-color: #2ecc71"
                      data-color="#2ecc71"
                    ></div>
                    <div
                      class="color-option"
                      style="background-color: #f39c12"
                      data-color="#f39c12"
                    ></div>
                    <div
                      class="color-option"
                      style="background-color: #9b59b6"
                      data-color="#9b59b6"
                    ></div>
                  </div>
                </div>
              </div>

              <div class="tab-pane" id="historyTab">
                <h4>Chat History</h4>
                <div class="history-list" id="historyList"></div>
                <div class="history-actions">
                  <button
                    class="history-btn delete"
                    id="clearAllHistory"
                    onclick="clearChatHistory()"
                  >
                    Clear All History
                  </button>
                </div>
              </div>

              <!-- SIRF LOGOUT TAB -->
              <div class="tab-pane" id="logoutTab">
                <div class="logout-section">
                  <div class="logout-icon">
                    <i class="fas fa-sign-out-alt"></i>
                  </div>
                  <h4>Logout from AI Tool</h4>
                  <p>Are you sure you want to logout? You'll need to sign in again to access your account.</p>
                  
                  <div class="logout-actions">
                    <button class="logout-btn-confirm" onclick="logout()">
                      <i class="fas fa-sign-out-alt"></i>
                      Yes, Logout
                    </button>
                    <button class="logout-btn-cancel" onclick="closeSettingsModal()">
                      <i class="fas fa-times"></i>
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelSettings">Cancel</button>
          <button class="btn btn-primary" id="saveSettings">Save</button>
        </div>
      </div>
    </div>

<script>
// MODIFIED AUTH CHECK - Allow guest access
document.addEventListener('DOMContentLoaded', function() {
    console.log("AI Problem Solve - Main App Loading");
    
    // Check if user is logged in or guest
    const token = localStorage.getItem('token');
    const currentUser = localStorage.getItem('currentUser');
    
    console.log("Auth status - Token:", !!token, "User:", !!currentUser);
    
    if (token && currentUser) {
        console.log("User authenticated, loading full app...");
        // Logged in user - full access
        initializeApp();
    } else {
        console.log("Guest user detected, showing limited access...");
        // Guest user - limited access (3 messages)
        showGuestInterface();
        initializeApp();
    }
});

// Show guest interface with message limit
async function showGuestInterface() {
    try {
        // Check guest message limit from backend
        const response = await fetch('https://python22.pythonanywhere.com/api/check-guest-limit', {
            method: 'GET',
            credentials: 'include' // Important for sessions
        });
        
        if (response.ok) {
            const data = await response.json();
            updateGuestCounter(data);
        } else {
            // If API fails, assume guest with 3 messages
            updateGuestCounter({ is_guest: true, remaining_messages: 3 });
        }
    } catch (error) {
        console.log('Guest limit check failed, using default:', error);
        updateGuestCounter({ is_guest: true, remaining_messages: 3 });
    }
}

// Update guest counter display
function updateGuestCounter(data) {
    const guestCounter = document.getElementById('guestCounter');
    const limitExceeded = document.getElementById('limitExceeded');
    const inputContainer = document.getElementById('inputContainer');
    const limitWarning = document.getElementById('limitWarning');
    const warningCount = document.getElementById('warningCount');
    
    if (data.is_guest) {
        const remaining = data.remaining_messages;
        
        if (remaining <= 0) {
            // Show limit exceeded message
            guestCounter.style.display = 'none';
            limitExceeded.style.display = 'block';
            inputContainer.classList.add('input-disabled');
            limitWarning.style.display = 'none';
            
            // Auto-redirect to login after 2 seconds
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            
        } else {
            // Show guest counter
            guestCounter.style.display = 'block';
            limitExceeded.style.display = 'none';
            inputContainer.classList.remove('input-disabled');
            
            // Update counter display
            document.getElementById('remainingMessages').textContent = remaining;
            const percentage = (remaining / 3) * 100;
            document.getElementById('progressFill').style.width = `${percentage}%`;
            
            // Update progress bar color
            const progressFill = document.getElementById('progressFill');
            if (remaining === 1) {
                progressFill.style.background = '#ff9800';
                limitWarning.style.display = 'flex';
                warningCount.textContent = '1';
            } else if (remaining === 2) {
                progressFill.style.background = '#ffeb3b';
                limitWarning.style.display = 'flex';
                warningCount.textContent = '2';
            } else {
                progressFill.style.background = '#4CAF50';
                limitWarning.style.display = 'none';
            }
        }
    } else {
        // User is logged in, hide guest elements
        guestCounter.style.display = 'none';
        limitExceeded.style.display = 'none';
        limitWarning.style.display = 'none';
        inputContainer.classList.remove('input-disabled');
    }
}

// Check guest limit
async function checkGuestLimit() {
    try {
        const response = await fetch('https://python22.pythonanywhere.com/api/check-guest-limit', {
            credentials: 'include'
        });
        if (response.ok) {
            const data = await response.json();
            updateGuestCounter(data);
        }
    } catch (error) {
        console.log('Guest limit check failed:', error);
    }
}

// Logout function
function logout() {
    if(confirm('Are you sure you want to logout?')) {
        // Clear all storage
        localStorage.removeItem('currentUser');
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        
        // Redirect to login
        window.location.href = "login.html";
    }
}

// Close settings modal function
function closeSettingsModal() {
    document.getElementById('settingsModal').style.display = 'none';
}

// Initialize app functionality
function initializeApp() {
    console.log("Initializing app features...");
    
    // Tab switching
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanes = document.querySelectorAll('.tab-pane');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabPanes.forEach(pane => pane.classList.remove('active'));
            
            this.classList.add('active');
            document.getElementById(targetTab + 'Tab').classList.add('active');
        });
    });

    // Modal functionality
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettings = document.getElementById('closeSettings');
    const cancelSettings = document.getElementById('cancelSettings');

    if(settingsBtn) {
        settingsBtn.addEventListener('click', function() {
            settingsModal.style.display = 'block';
        });
    }

    if(closeSettings) {
        closeSettings.addEventListener('click', closeSettingsModal);
    }

    if(cancelSettings) {
        cancelSettings.addEventListener('click', closeSettingsModal);
    }

    // Save settings
    const saveSettings = document.getElementById('saveSettings');
    if(saveSettings) {
        saveSettings.addEventListener('click', function() {
            closeSettingsModal();
            alert('Settings saved successfully!');
        });
    }

    // Show current user info
    try {
        const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
        console.log("Current user:", userData);
        if(userData.email) {
            console.log("Welcome:", userData.email);
        }
    } catch(e) {
        console.log("User data format issue:", e);
    }

    console.log("App initialized successfully!");
}

// Updated sendMessage function with guest limit check
async function sendMessage() {
    const userInput = document.getElementById('userInput');
    const message = userInput.value.trim();
    
    if(!message) return;
    
    // Check if user is guest and has reached limit
    const guestCounter = document.getElementById('guestCounter');
    if (guestCounter.style.display !== 'none') {
        const remaining = parseInt(document.getElementById('remainingMessages').textContent);
        if (remaining <= 0) {
            // No alert, just don't send message
            return;
        }
    }
    
    console.log("Sending message:", message);
    
    try {
        // Send message to backend API
        const response = await fetch('https://python22.pythonanywhere.com/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                message: message,
                conversation_id: 'default'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Add message to chat
            addMessageToChat(message, 'user');
            addMessageToChat(data.response, 'ai');
            
            // Update guest counter after successful message
            if (data.remaining_messages !== 'unlimited') {
                updateGuestCounter({
                    is_guest: true,
                    remaining_messages: data.remaining_messages
                });
            }
        } else {
            if (data.limit_exceeded) {
                // Show limit exceeded and redirect (no alert)
                updateGuestCounter({
                    is_guest: true,
                    remaining_messages: 0
                });
                // Auto redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        }
    } catch (error) {
        console.error('Error sending message:', error);
        // Fallback: Add message to chat even if API fails
        addMessageToChat(message, 'user');
        setTimeout(() => {
            addMessageToChat("I understand: " + message, 'ai');
        }, 1000);
        
        // Simulate message count decrease for guest
        setTimeout(checkGuestLimit, 500);
    }
    
    userInput.value = '';
}

// Helper function to add messages to chat
function addMessageToChat(message, sender) {
    const messagesContainer = document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    messageDiv.textContent = message;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function clearChatHistory() {
    if(confirm('Are you sure you want to clear all chat history?')) {
        console.log("Chat history cleared");
        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.innerHTML = '';
        alert('Chat history cleared!');
    }
}

// Check guest limit when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initial check
    setTimeout(checkGuestLimit, 1000);
});
</script>
    <script src="script.js"></script>
  </body>
</html>
